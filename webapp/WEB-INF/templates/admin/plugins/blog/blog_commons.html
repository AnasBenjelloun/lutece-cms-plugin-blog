<#macro blogEditor lang='fr_FR' colorsMap=''  >
<script src="themes/admin/shared/plugins/blog/js/tinymce/tinymce.min.js"></script>
<script src="themes/admin/shared/plugins/blog/js/tinymce/langs/${lang}.js"></script>
<script>
var baseUrl='${webapp_url}';
var colorMap =  [
  "FFFFFF", "FFFFFF",
  "000000", "000000",
  "071F32", "071F32",
  "354BCF", "354BCF",
  "E22C3F", "E22C3F",
  "248619", "248619",
  "D14800", "D14800",
  "31EEF3", "31EEF3",
  "25DCCC", "25DCCC",
  "3ECD2E", "3ECD2E",
  "FFCD00", "FFCD00",
  "FF3300", "FF3300"
];

var fontsizes = '10px 11px 12px 14px 16px 18px 20px 22px 24px 26px 28px 36px 48px 72px';
var contentBodyConfig = {
  selector: '.content-body',
  menubar: false,
  inline: true,
  plugins: [
    'autolink',
    'code',
    'image',
    'importcss',
    'link',
    'lists',
    'media',
    'table',
    'paste',
    'quickbars',
    'help'
  ],
  toolbar: false,
  quickbars_insert_toolbar: 'quicktable image media code',
  quickbars_selection_toolbar: 'undo redo | paste | formatselect fontsizeselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | blockquote link',
  language: '${lang}',
  document_base_url : '${webapp_url}',
  color_map: colorMap,
  inline: true,
  /* enable automatic uploads of images represented by blob or data URIs*/
  automatic_uploads: false,
  images_upload_url: '',
  image_caption: true,
  image_advtab: true,
  /*
    URL of our upload handler 
    here we add custom filepicker only to Image dialog
  */
  file_picker_types: 'image',
  /* and here's our custom image picker*/
  file_picker_callback: function (cb, value, meta) {
    let fileRes = '';
    let input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.onchange = function () {
      const file = this.files[0];
      const reader = new FileReader();
      reader.onload = function () {
        let blogId = document.querySelector('#id').value;
        const fileType=1; 
        doAddContent( file.name, file.size, reader.result, fileType, blogId ).then( resp => {
          /* call the callback and populate the Title field with the file name */
          if ( resp.status == 'OK' ){
            if( resp.result == "BLOG_LOCKED" ){
              setBlogToast( 'warning', '#i18n{portal.util.labelDanger}', '#i18n{blog.message.blogLocked}' );
            } else {
              setListFile( resp.result[1], resp.result[0], fileType, blogId )
              <#noparse>fileRes = `servlet/plugins/blogs/file?id_file=${resp.result[1]}`</#noparse>;
              /* call the callback and populate the Title field with the file name */
              cb( fileRes , { title: file.name });
            }
          }
        });
      };
      reader.readAsDataURL(file);
    };
    input.click();
  },
  content_css: "css/page_template_styles.css",
  importcss_append: false,
  extended_valid_elements : "iframe[style|src|width|height|name|align|frameborder|scrolling],script[src|type]",
  paste_word_valid_elements: "b,strong,i,em,h1,h2,h3,h4,h5,h6,p,br,blockquote",
  fontsize_formats: fontsizes,
  target_list: [
    {title: 'None', value: ''},
    {title: 'Même page', value: '_self'},
    {title: 'Nouvelle page', value: '_blank'},
    {title: 'Fenêtre Parent', value: '_parent'}
  ],
  contextmenu: 'undo redo | image insert | inserttable | cell row column deletetable | code | help'
};

var contentDescConfig = {
  selector: '.content-desc',
  language: 'fr_FR',
  height: 250,
  menubar: false,
  inline: true,
  toolbar: false,
  plugins: [ 'quickbars' ],
  quickbars_insert_toolbar: 'undo redo',
  quickbars_selection_toolbar: 'italic bold'
};
document.addEventListener("DOMContentLoaded", function() {
  tinymce.init( contentBodyConfig );
	tinymce.init( contentDescConfig );
})
</script>
</#macro>
<#macro blogScriptInit >
<@initToast id='blogToastContainer' showAll=false >
<@addToast id='blogToast' content='to change' />
</@initToast>
<script>
var msgErrorTagExist = '#i18n{blog.message.errorTagExist}' 
var msgErrorTagUpdatePosition = '#i18n{blog.message.errorTagUpdatePosition}' 
var msgErrorTagDeletion = '#i18n{blog.message.errorTagDeletion}' 
var msgErrorTagTitleNotEmpty = '#i18n{blog.message.errorTagTitleNotEmpty}'
var msgErrorTagNotSet = '#i18n{blog.message.message.errorTagNotSet}'

var msgErrorBlogLocked = '#i18n{blog.message.blogLocked}' 
var msgErrorBlogFileCannotBeDeleted = '#i18n{blog.message.blogFileCannotBeDeleted}' 
var msgErrorBlogFileTypeNotUpdated = '#i18n{blog.message.blogFileTypeNotUpdated}' 

var labelWarning='#i18n{portal.util.labelWarning}'
var labelDanger='#i18n{portal.util.labelDanger}'
var labelError='#i18n{portal.util.message.titleError}'

function setBlogToast( toastType, toastTitle, toastContent ){
	const toastBlog = document.querySelector('#blogToast');
  const toastBlogItem = bootstrap.Toast.getOrCreateInstance('#blogToast');
  if( toastType !='' ){ <#noparse>toastBlog.classList.add( `text-bg-warning` );</#noparse> }
	const blogToastBody = document.querySelector( '#blogToast .toast-body' );
  blogToastBody.innerHTML = <#noparse>`<h2>${toastTitle}</h2><p>${toastContent}</p>`</#noparse>
	toastBlogItem.show()
}

document.addEventListener( "DOMContentLoaded", function(){
  const formEditor = document.querySelector('#form-editor'), 
  dLabel=document.querySelector('#div_content_label') , iLabel=document.querySelector('#content_label'),
  dDesc=document.querySelector('#div_description') , iDesc=document.querySelector('#description'),
  dHtml=document.querySelector('#div_html_content') , iHtml=document.querySelector('#html_content');

  formEditor.addEventListener( "submit", event => {
    const t = dLabel.textContent.replace('\n','').replace('#i18n{blog.message.default.blogTitle}','').trim();
    if( t == '' ){
      setBlogToast( 'warning' , '#i18n{blog.message.blogTitleNotEmpty}', ''  );
      event.preventDefault();
      dLabel.focus({ focusVisible: true })
      return false;
    } else {
      iLabel.value = t ;
    }
    
    const d = dDesc.textContent.replace('#i18n{blog.message.default.blogDescription}','').trim();
    if( d == '' ) {
      setBlogToast( 'warning' , '#i18n{blog.message.blogDescriptionNotEmpty}', ''  )	
      event.preventDefault();
      dDesc.focus({ focusVisible: true })
      return false;
    } else {
      iDesc.value = d;
    }

    iHtml.value = dHtml.innerHTML.trim();
    
    if( document.querySelector("#tag-list li") != null ){
      const tagsLen = document.querySelector("#tag-list li").length;
      if ( tagsLen == 0  ){
        setBlogToast( 'warning' , '#i18n{blog.message.message.errorTagNotSet}', '' )
        event.preventDefault();
        return false;
      }
    }
  });

  /* Offcanvas  */
  /* Tags       */
  const idBlog = document.querySelector('#id').value;
  const myOffcanvas = document.getElementById('blog-properties')
  myOffcanvas.addEventListener('show.bs.offcanvas', event => {
    const btnAddTag = document.querySelector( "#addTag" )
    btnAddTag.addEventListener( 'click', function(e){
      const tagDoc = document.querySelector('#tag_doc');
      const index = tagDoc.selectedIndex;
      const selOption = tagDoc.options[ index ].textContent;
      doAddTag( tagDoc.value, selOption, idBlog );
    });

    const btnCreateTag = document.querySelector( "#createTag" )
    btnCreateTag.addEventListener( 'click', event => {
      createTag( idBlog );
    });

    const btnAddFiles = document.querySelector("#btn-add-files")
    btnAddFiles.addEventListener( 'click', event => {
      document.querySelector('#attachment').click();
    });

    <#if blog??>
    <#if !blog.docContent??>
    const previewAtt = document.querySelector("#preview_attachment")
    if ( previewAtt.style.display == 'none' ) {
      previewAtt.style.display = '';
    } else {
      previewAtt.style.display = 'none';
    }
    </#if>
    </#if>
    })

    // TODO Limite les saisies Titre et Description
    // limitInputCharacters( 'div_content_label', 75 );
    // limitInputCharacters( 'div_description', 300 );

});
</script>
<script src="themes/admin/shared/plugins/blog/js/blog.js"></script>
</#macro>