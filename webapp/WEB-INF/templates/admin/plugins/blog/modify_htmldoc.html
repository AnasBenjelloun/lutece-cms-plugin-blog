<#include "/admin/util/editor/editor.html" />
<form class="form" method="post" name="modify_htmldoc" id="form-editor" enctype="multipart/form-data" action="jsp/admin/plugins/blog/ManageHtmlDocs.jsp">
    <@messages errors=errors />
    <input type="hidden" id="id" name="id" value="${htmldoc.id}">
    <input type="hidden" id="action" name="action" value="modifyHtmlDoc">
    <div class="row">
        <article class="col-xs-12 col-sm-10">
            <div class="form-group">
                <label for="content_label" class="sr-only">#i18n{blog.modify_htmldoc.labelContentLabel} </label>
                <input class="form-control" name="content_label" id="content_label" type="text" placeholder="#i18n{blog.modify_htmldoc.labelContentLabel.help}" value="${htmldoc.contentLabel}" required>
            </div>
            <div class="form-group">
                <label for="html_content" class="sr-only">#i18n{blog.modify_htmldoc.labelEditContent} </label>
                <textarea id="html_content" class="richtext" name="html_content" rows="12"> ${htmldoc.htmlContent!}</textarea>
                <@initEditor  />
            </div>
        </article>
        <aside class="col-xs-12 col-sm-2 aside">
            <div class="form-group">
                <button class="btn btn-primary btn-block" type="submit" title="OK" name="action_modifyHtmlDoc">
                  <i class="fa fa-check" aria-hidden="true"></i> #i18n{portal.util.labelModify}
                </button>
                <button class="btn btn-default btn-flat hidden" type="submit" title="Annuler" name="view_manageHtmlDocs">
                  <i class="fa fa-close" aria-hidden="true"></i> #i18n{portal.util.labelCancel}
                </button>
            </div>
            <div class="box-group hidden" id="publication-group">
              <div class="panel box box-warning">
                <a data-toggle="collapse" data-parent="#publication-group" href="#collapsePublication" class="collapsed" aria-expanded="false">
                  <div class="box-header with-border">
                    <h4 class="box-title">
                      Publication
                      <#if htmldoc.htmldocPubilcation?size &gt; 0>
                         <span class="notification left bg-purple-active">${htmldoc.htmldocPubilcation?size}</span>
                      </#if>
                    </h4>
                  </div>
                </a>
                <div id="collapsePublication" class="panel-collapse collapse" aria-expanded="false">
                  <div class="panel-body">
                    <div class="box-body">
                      <a href="jsp/admin/plugins/blog/ManagePublicationHtmlDocs.jsp?view=manageHtmlDocsPublication&id=${htmldoc.id}"
                        class="btn-publish btn btn-sm <#if htmldoc.htmldocPubilcation?size == 0>btn-default<#else>btn-primary notif</#if>" title="<#if htmldoc.htmldocPubilcation?size==0>Publier<#else>#i18n{blog.modify_htmldocs.managePublication}</#if>">
                        <i class="fa fa-globe"></i>

                      </a>
                      <#if htmldoc.htmldocPubilcation?size &gt; 0>
                        <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          <span class="caret"></span>
                          <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                          <#list htmldoc.htmldocPubilcation as publication>
                            <li>
                              <div class="btn-group" role="group" aria-label="...">
                                <a href="jsp/admin/plugins/blog/ManagePublicationHtmlDocs.jsp?action=unPublishDocument&idDocument=${htmldoc.id}&idPortlet=${publication.idPortlet}&id=${htmldoc.id}"
                                    class="btn btn-danger btn-xs hidden" title="Depublier"><i class="fa fa-remove"></i></a>
                                 <a href='jsp/admin/site/AdminSite.jsp?page_id=${publication.portlet.pageId}' class="btn btn-link"  title="Publie du ${publication.dateBeginPublishing} au ${publication.dateEndPublishing}">
                                   ${publication.portlet.name} - Page ${publication.portlet.pageId} <i class="fa fa-external-link" aria-hidden="true"></i>
                                 </a>
                              </div>
                             </li>
                          </#list>
                       </ul>
                      </#if>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="box-group" id="extend-group">
              <div class="panel box box-success">
                <a data-toggle="collapse" data-parent="#extend-group" href="#collapseExtend" class="collapsed" aria-expanded="false">
                  <div class="box-header with-border">
                    <h4 class="box-title">#i18n{blog.dashboard.columnActions} </h4>
                  </div>
                </a>
                <div id="collapseExtend" class="panel-collapse collapse" aria-expanded="false">
                  <div class="panel-body">
                    <@btnGroup>
                      <#if extendableResourceActionsHtml?? && extendableResourceActionsHtml?has_content>
                         ${extendableResourceActionsHtml!}
                      </#if>
                      <a href="jsp/admin/plugins/blog/ManagePublicationHtmlDocs.jsp?view=manageHtmlDocsPublication&amp;id=${htmldoc.id}"
                        class="btn-publish btn btn-flat btn-primary" title="#i18n{blog.modify_htmldocs.managePublication}">
                        <i class="fa fa-globe"></i>
                      </a>
                      <a href="jsp/admin/plugins/blog/ManageHtmlDocs.jsp?view=historyHtmlDoc&amp;d=${htmldoc.id}" class="btn btn-primary btn-flat" title="#i18n{blog.manage_htmldocs.labelHistory}  ${htmldoc.version} versions ">
                        <i class="fa fa-history"></i>
                      </a>
                      <a href="jsp/admin/plugins/blog/ManageHtmlDocs.jsp?action=confirmRemoveHtmlDoc&amp;id=${htmldoc.id}" class="btn btn-danger btn-flat" title="#i18n{portal.util.labelDelete}">
                        <i class="fa fa-trash"></i>
                      </a>
                    </@btnGroup>
                  </div>
                </div>
              </div>
            </div>
            <div class="box-group" id="desc-group">
              <div class="panel box box-primary">
                <a data-toggle="collapse" data-parent="#desc-group" href="#collapseDesc" class="collapsed" aria-expanded="false">
                  <div class="box-header with-border">
                    <h4 class="box-title">#i18n{blog.modify_htmldoc.labelDescription}</h4>
                  </div>
                </a>
                <div id="collapseDesc" class="panel-collapse collapse" aria-expanded="false">
                  <div class="panel-body">
                    <label for="description" class="sr-only">#i18n{blog.modify_htmldoc.labelEditComment}</label>
                    <textarea id="description" class="form-control" name="description" rows="2">${htmldoc.description!}</textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="box-group" id="tags-group">
              <div class="panel box box-primary">
                <a data-toggle="collapse" data-parent="#tags-group" href="#collapseTags" class="collapsed" aria-expanded="false">
                  <div class="box-header with-border">
                    <h4 class="box-title">#i18n{blog.modify_htmldoc.TagsTitle}</h4>
                  </div>
                </a>
                <div id="collapseTags" class="panel-collapse collapse" aria-expanded="false">
                  <div class="panel-body">
                    <div class="form-group">
                      <label for="addTag" class="sr-only">#i18n{blog.manage_tags.buttonAdd}</label>
                      <div class="input-group">
                        <@comboSortedWithParams name="tag_doc" default_value="" additionalParameters="class=\"form-control\"" items=list_tag />
                        <span class="input-group-btn">
                          <button type="button" value="addTag" id="addTag" name="addTag" class="btn btn-primary">
                            <i class="fa fa-tag"></i>
                         </button>
                        </span>
                      </div>
                    </div>
                    <ul id="tag-list" class="list-group">
                      <#list htmldoc.tag as tg>
                   			<li id="tag_${tg.idTag}" class="list-group-item clearfix" title="${tg.name}">
                          <span class="pull-left">${tg.name?string[0..*14]}<#if tg.name?length &gt; 14>...</#if></span>
                          <span class="pull-right">
                    			  <button type="button" class="btn btn-primary btn-xs btn-flat btn-down" title="Descendre" onclick="doUpdatePriorityTag( ${tg.idTag}, 'moveDown' );">
             				  				<i class="fa fa-arrow-down"></i>
                     			  </button>
                     				<button type="button" class="btn btn-primary btn-xs btn-flat btn-up" title="Monter" onclick="doUpdatePriorityTag( ${tg.idTag}, 'moveUp');">
               								<i class="fa fa-arrow-up"></i>
                     				</button>
                     				<button type="button" value="removeTag" name="removeTag" class="btn btn-danger btn-xs btn-flat" onclick="doDeleteTag( ${tg.idTag}, '${tg.name!}');">
                     					<i class="fa fa-trash"></i>&nbsp;
                     	   		</button>
                          </span>
                 				</li>
                 		 </#list>
                    </ul>
                    <label for="tag_name" class="sr-only">#i18n{blog.manage_tags.buttonAdd}</label>
                      <div class="input-group">
                        <input type="text" id="tag_name" class="form-control" name="tag_name" value="" placeholder="#i18n{blog.manage_tags.buttonAdd}">
                        <span class="input-group-btn">
                          <button type="button" value="createTag" id="createTag" name="createTag" class="btn btn-primary" title="#i18n{blog.create_tag.pageTitle}">
                            <i class="fa fa-plus"></i>
                          </button>
                        </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="box-group" id="attachment-group">
              <div class="panel box box-primary">
                <a data-toggle="collapse" data-parent="#attachment-group" href="#collapseAttachment" class="collapsed" aria-expanded="false">
                  <div class="box-header with-border">
                    <h4 class="box-title">#i18n{blog.modify_htmldoc.labelImage}</h4>
                  </div>
                </a>
                <div id="collapseAttachment" class="panel-collapse collapse" aria-expanded="false">
                  <div class="panel-body">
                      <div class="form-group">
                        <label for="attachment" class="sr-only">#i18n{blog.modify_htmldoc.labelAttachment}</label>
                        <input class="filestyle" name="attachment" id="attachment" type="file" data-iconName="fa fa-image" data-buttonText="" value="servlet/plugins/htmldocs/file?id_file=${htmldoc.id}">
                        <div class="text-center">
                          <#if htmldoc.docContent??>
                            <a href="servlet/plugins/htmldocs/file?id_file=${htmldoc.id}" title="preview">
                              ${htmldoc.docContent.textValue!} <img id="preview_attachment" src="servlet/plugins/htmldocs/file?id_file=${htmldoc.id}" alt="Preview" class="img-responsive img-thumbnail">
                            </a>
                          <#else>
                            <img id="preview_attachment" src="images/none.jpg" alt="Preview" class="img-responsive img-thumbnail">
                          </#if>
                        </div>
                      </div>
                      <div class="form-group" id="group_update_attachment">
                        <div class="checkbox">
                          <label for="update_attachment">
                            <input name="update_attachment" id="update_attachment" value="1" type="checkbox"> Supprimer l'image
                          </label>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="box-group" id="comments-group">
              <div class="panel box box-primary">
                <a data-toggle="collapse" data-parent="#comments-group" href="#collapseUrl" class="collapsed" aria-expanded="false">
                  <div class="box-header with-border">
                    <h4 class="box-title">#i18n{blog.create_htmldoc.labelUrl}</h4>
                  </div>
                </a>
                <div id="collapseUrl" class="panel-collapse collapse" aria-expanded="false">
                  <div class="panel-body">
                    <label for="url" class="sr-only">#i18n{blog.create_htmldoc.labelUrl</label>
                    <input class="form-control" name="url" id="url" type="text" value="${htmldoc.url!}">
                  </div>
                </div>
            </div>
          </div>
            <div class="box-group" id="comments-group">
              <div class="panel box box-primary">
                <a data-toggle="collapse" data-parent="#comments-group" href="#collapseComment" class="collapsed" aria-expanded="false">
                  <div class="box-header with-border">
                    <h4 class="box-title">#i18n{blog.create_htmldoc.labelEditComment}</h4>
                  </div>
                </a>
                <div id="collapseComment" class="panel-collapse collapse" aria-expanded="false">
                  <div class="panel-body">
                    <label for="edit_comment" class="sr-only">#i18n{blog.create_htmldoc.labelEditComment}</label>
                    <input class="form-control" name="edit_comment" id="edit_comment" type="text" value="">
                  </div>
                </div>
            </div>
          </div>
        </aside>
    </div>
</form>
<script src="js/plugins/blog/manage_tag.js"></script>
<script>
function readURL( input ){
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    reader.onload = function(e) {
      $('#preview_attachment').attr('src', e.target.result);
      $("#preview_attachment").toggle();
      $("#group_update_attachment").toggle();
    }
    reader.readAsDataURL(input.files[0]);
  }
}

$( function(){
  $("#createTag").click( function(){
    createTag();
  });

  $("#addTag").click( function(){
    doAddTag( $('#tag_doc').val(), $('#tag_doc option:selected').text() );
  });

  <#if !htmldoc.docContent??>
    $("#preview_attachment").toggle();
    $("#group_update_attachment").toggle();
  </#if>

  $("#attachment").change(function() {
   readURL(this);
  });

  $(".btn-publish").click(function (e) {
    e.preventDefault();
    $('#previewModalFrame').hide();
    urlPublished = $(this).attr("href");
    $('#loader').show();
    $('#previewModal').modal({ show: true });
  });

  $('#previewModal').on('shown.bs.modal', function () {
      $('#previewModalFrame').attr("src", urlPublished );
      $('#previewModalFrame').load( function () {
        $('#previewModalFrame').show();
        $('#loader').hide();
      });
  });

});
</script>
<div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel">
    <div class="modal-dialog modal-lg" role="document" >
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn btn-link pull-right" data-dismiss="modal" aria-label="Close"><i class="fa fa-remove" aria-hidden="true"></i></button>
                <h4 class="modal-title" id="previewModalLabel">Publication</h4>
            </div>
            <div class="modal-body">
                <p id="loader" class="text-center">
                    <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw"></i>
                    <span class="sr-only">Chargement...</span>
                </p>
                <iframe style="width:100%;height:60vh;border:0" frameborder="0" id="previewModalFrame" src=""></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
